"use strict";(()=>{var e={};e.id=2,e.ids=[2],e.modules={67096:e=>{e.exports=require("bcrypt")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84629:e=>{e.exports=import("@libsql/client")},9932:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{originalPathname:()=>_,patchFetch:()=>n,requestAsyncStorage:()=>o,routeModule:()=>l,serverHooks:()=>h,staticGenerationAsyncStorage:()=>p});var a=s(49303),i=s(88716),d=s(60670),u=s(75414),c=e([u]);u=(c.then?(await c)():c)[0];let l=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:"app/api/auth/register/route"},resolvedPagePath:"/Users/bytedance/Desktop/nababa-dress/src/app/api/auth/register/route.ts",nextConfigOutput:"",userland:u}),{requestAsyncStorage:o,staticGenerationAsyncStorage:p,serverHooks:h}=l,_="/api/auth/register/route";function n(){return(0,d.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:p})}r()}catch(e){r(e)}})},75414:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{POST:()=>c});var a=s(87070),i=s(44758),d=s(17114),u=e([i]);i=(u.then?(await u)():u)[0];let n=d.Ry({email:d.Z_().email("请输入有效的邮箱地址"),password:d.Z_().min(6,"密码至少6个字符"),confirmPassword:d.Z_()}).refine(e=>e.password===e.confirmPassword,{message:"两次输入的密码不一致",path:["confirmPassword"]});async function c(e){try{let t=await e.json(),s=n.safeParse(t);if(!s.success)return a.NextResponse.json({success:!1,message:"输入数据无效",errors:s.error.issues},{status:400});let{email:r,password:d}=s.data,u=await i.G.createUser({email:r,password:d});return a.NextResponse.json({success:!0,message:"注册成功",user:{id:u.id,email:u.email,credits:u.credits,user_level:u.user_level}})}catch(e){if(console.error("注册失败:",e),e instanceof Error)return a.NextResponse.json({success:!1,message:e.message},{status:400});return a.NextResponse.json({success:!1,message:"注册失败，请稍后重试"},{status:500})}}r()}catch(e){r(e)}})},44758:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.d(t,{G:()=>c});var a=s(75748),i=s(67096),d=s.n(i),u=e([a]);a=(u.then?(await u)():u)[0];class c{static async createUser(e){let{email:t,password:s}=e;if(await this.findUserByEmail(t))throw Error("邮箱已被注册");let r=await d().hash(s,12),i=(await a.w.execute({sql:`INSERT INTO users (email, password_hash, user_level, credits) 
            VALUES (?, ?, ?, ?) RETURNING *`,args:[t,r,"free",6]})).rows[0];return{id:i.id,email:i.email,password_hash:i.password_hash,user_level:i.user_level,credits:i.credits,wechat_upgraded:!!i.wechat_upgraded,created_at:new Date(i.created_at),updated_at:new Date(i.updated_at)}}static async findUserByEmail(e){let t=await a.w.execute({sql:"SELECT * FROM users WHERE email = ?",args:[e]});if(0===t.rows.length)return null;let s=t.rows[0];return{id:s.id,email:s.email,password_hash:s.password_hash,user_level:s.user_level,credits:s.credits,wechat_upgraded:!!s.wechat_upgraded,created_at:new Date(s.created_at),updated_at:new Date(s.updated_at)}}static async findUserById(e){let t=await a.w.execute({sql:"SELECT * FROM users WHERE id = ?",args:[e]});if(0===t.rows.length)return null;let s=t.rows[0];return{id:s.id,email:s.email,password_hash:s.password_hash,user_level:s.user_level,credits:s.credits,wechat_upgraded:!!s.wechat_upgraded,created_at:new Date(s.created_at),updated_at:new Date(s.updated_at)}}static async verifyPassword(e,t){return await d().compare(e,t)}static async updateUser(e,t){let s=[],r=[];void 0!==t.user_level&&(s.push("user_level = ?"),r.push(t.user_level)),void 0!==t.credits&&(s.push("credits = ?"),r.push(t.credits)),void 0!==t.wechat_upgraded&&(s.push("wechat_upgraded = ?"),r.push(t.wechat_upgraded)),s.push("updated_at = CURRENT_TIMESTAMP"),r.push(e);let i=`UPDATE users SET ${s.join(", ")} WHERE id = ? RETURNING *`,d=await a.w.execute({sql:i,args:r});if(0===d.rows.length)throw Error("用户不存在");let u=d.rows[0];return{id:u.id,email:u.email,password_hash:u.password_hash,user_level:u.user_level,credits:u.credits,wechat_upgraded:!!u.wechat_upgraded,created_at:new Date(u.created_at),updated_at:new Date(u.updated_at)}}static async deductCredits(e,t){let s=await this.findUserById(e);if(!s)throw Error("用户不存在");if(s.credits<t)throw Error("积分不足");return await this.updateUser(e,{credits:s.credits-t})}static async addCredits(e,t){let s=await this.findUserById(e);if(!s)throw Error("用户不存在");return await this.updateUser(e,{credits:s.credits+t})}static async updateUserCredits(e,t){let s=await this.findUserById(e);if(!s)throw Error("用户不存在");let r=s.credits+t;if(r<0)throw Error("积分不足");return await this.updateUser(e,{credits:r})}static async getUserLevel(e){let t=await this.findUserById(e);return t?t.user_level:null}static async isPremiumUser(e){let t=await this.findUserById(e);return!!t&&("plus"===t.user_level||"pro"===t.user_level)}static async isProUser(e){let t=await this.findUserById(e);return!!t&&"pro"===t.user_level}static async upgradeToPlusUser(e){return await this.updateUser(e,{user_level:"plus",wechat_upgraded:!0})}static async upgradeToProUser(e){return await this.updateUser(e,{user_level:"pro"})}static async getUserStats(e){let[t,s]=await Promise.all([a.w.execute({sql:`SELECT 
                COUNT(*) as total_generations,
                COUNT(CASE WHEN status = 'completed' THEN 1 END) as successful_generations,
                COUNT(CASE WHEN status = 'failed' THEN 1 END) as failed_generations,
                SUM(credits_used) as total_credits_used
              FROM generation_history 
              WHERE user_id = ?`,args:[e]}),a.w.execute({sql:"SELECT credits FROM users WHERE id = ?",args:[e]})]),r=t.rows[0],i=s.rows[0];return{total_generations:r.total_generations||0,successful_generations:r.successful_generations||0,failed_generations:r.failed_generations||0,total_credits_used:r.total_credits_used||0,current_credits:i?.credits||0}}}r()}catch(e){r(e)}})},75748:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.d(t,{w:()=>d});var a=s(84629),i=e([a]);a=(i.then?(await i)():i)[0];let d=(0,a.createClient)({url:process.env.TURSO_DATABASE_URL,authToken:process.env.TURSO_AUTH_TOKEN});r()}catch(e){r(e)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[276,972,114],()=>s(9932));module.exports=r})();