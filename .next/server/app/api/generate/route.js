"use strict";(()=>{var e={};e.id=290,e.ids=[290],e.modules={67096:e=>{e.exports=require("bcrypt")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84629:e=>{e.exports=import("@libsql/client")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},38937:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{originalPathname:()=>h,patchFetch:()=>c,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>d,staticGenerationAsyncStorage:()=>g});var a=s(49303),o=s(88716),n=s(60670),i=s(26047),u=e([i]);i=(u.then?(await u)():u)[0];let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/generate/route",pathname:"/api/generate",filename:"route",bundlePath:"app/api/generate/route"},resolvedPagePath:"/Users/bytedance/Desktop/nababa-dress/src/app/api/generate/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:d}=l,h="/api/generate/route";function c(){return(0,n.patchFetch)({serverHooks:d,staticGenerationAsyncStorage:g})}r()}catch(e){r(e)}})},26047:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{POST:()=>g});var a=s(87070),o=s(45609),n=s(95456),i=s(44758),u=s(18289),c=s(17114),l=e([n,i,u]);[n,i,u]=l.then?(await l)():l;let d=c.Ry({userImage:c.Z_().min(1,"请上传用户照片"),clothingImages:c.IX(c.Z_()).min(1,"请至少上传一件服装图片"),generationType:c.Km(["single","batch"]).default("single")}),h=process.env.APICORE_AI_KEY||"sk-yUPD9rfqfCrhxVzwmadPNlR3dtQ67PqWshJVgYihz8EWWU8D",m=(e=1)=>{let t=`请将用户照片中的人物换上新的服装，要求：
1. 保持人物的面部特征、发型、体型和姿态完全不变
2. 服装要自然贴合人物身形，考虑光影和褶皱效果  
3. 保持原照片的背景、光线和整体氛围
4. 生成真实感强的穿着效果，避免违和感
5. 确保服装的材质、颜色和细节准确还原`,s=e>1?`
6. 请为这一个人物分别生成穿着每件不同服装的效果图，每张图保持人物一致性`:"";return t+s};async function p(e,t,s=0){let r=m(t.length),a=[{type:"text",text:r},{type:"image_url",image_url:{url:e.startsWith("data:")?e:`data:image/jpeg;base64,${e}`}}];t.forEach(e=>{a.push({type:"image_url",image_url:{url:e.startsWith("data:")?e:`data:image/jpeg;base64,${e}`}})});try{let e;console.log(`AI生成请求开始 (重试次数: ${s})`);let t=await fetch("https://kg-api.cloud/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h}`},body:JSON.stringify({model:"gemini-2.5-flash-image-preview",messages:[{role:"user",content:a}],max_tokens:500}),signal:AbortSignal.timeout(6e4)});if(!t.ok)throw Error(`API调用失败: ${t.status} ${t.statusText}`);let r=await t.json();if(console.log("AI生成响应:",r),!r.choices||!r.choices[0]||!r.choices[0].message)throw Error("API返回格式异常");let o=r.choices[0].message.content;console.log("AI响应内容:",o);let n=[],i=/!\[.*?\]\(((?:data:image\/[^;]+;base64,|https?:\/\/)[^\)]+)\)/g;for(;null!==(e=i.exec(o));)n.push(e[1]);if(0===n.length){let t=/(data:image\/[^;]+;base64,[A-Za-z0-9+/=]+)/g;for(;null!==(e=t.exec(o));)n.push(e[1])}if(0===n.length){let t=/(https?:\/\/[^\s<>"{}|\\^`\[\]]+\.(png|jpg|jpeg|gif|webp))/gi;for(;null!==(e=t.exec(o));)n.push(e[1])}if(0===n.length){let t=/(https?:\/\/[^\s<>"{}|\\^`\[\]]+)/g;for(;null!==(e=t.exec(o));)n.push(e[1])}if(0===n.length)throw Error("未从AI响应中提取到图片URL");return console.log(`成功生成 ${n.length} 张图片`),n}catch(r){if(console.error(`AI生成失败 (重试次数: ${s}):`,r),s<2)return console.log(`准备重试 ${s+1}/2`),await p(e,t,s+1);throw r}}async function g(e){try{let t=await (0,o.getServerSession)(n.L);if(!t?.user?.id)return a.NextResponse.json({success:!1,message:"请先登录"},{status:401});let s=parseInt(t.user.id),r=await e.json(),c=d.safeParse(r);if(!c.success)return a.NextResponse.json({success:!1,message:"输入数据无效",errors:c.error.issues},{status:400});let{userImage:l,clothingImages:g,generationType:h}=c.data,m=await i.G.findUserById(s);if(!m)return a.NextResponse.json({success:!1,message:"用户不存在"},{status:404});let x=g.length,f=m.user_level;if("free"===f&&x>1)return a.NextResponse.json({success:!1,message:"Free用户只能上传1件服装图片，请升级到Plus或Pro"},{status:403});if("plus"===f&&x>3)return a.NextResponse.json({success:!1,message:"Plus用户最多上传3件服装图片，请升级到Pro"},{status:403});if("pro"===f&&x>10)return a.NextResponse.json({success:!1,message:"Pro用户最多上传10件服装图片"},{status:403});let y=x>1&&"pro"===f,j=y?20:2;if(m.credits<j)return a.NextResponse.json({success:!1,message:`积分不足，需要${j}积分，当前余额${m.credits}积分`,requiredCredits:j,currentCredits:m.credits},{status:402});await i.G.updateUserCredits(s,-j);let q=await u.K.createGenerationHistory(s,j,x,y?"batch":"single");try{console.log(`开始AI生成：用户${s}, 服装数量${x}, 类型${y?"批量":"单次"}`);let e=await p(l,g);return await u.K.updateGenerationStatus(q.id,"completed"),console.log(`AI生成成功：用户${s}, 生成${e.length}张图片`),a.NextResponse.json({success:!0,message:`生成成功！消耗${j}积分`,data:{images:e,creditsUsed:j,generationType:y?"batch":"single",generatedCount:e.length}})}catch(e){return console.error("AI生成最终失败:",e),await i.G.updateUserCredits(s,j),await u.K.updateGenerationStatus(q.id,"failed",e instanceof Error?e.message:"未知错误"),a.NextResponse.json({success:!1,message:"生成失败，积分已退还。请稍后重试",error:e instanceof Error?e.message:"未知错误"},{status:500})}}catch(e){return console.error("生成请求处理失败:",e),a.NextResponse.json({success:!1,message:"请求处理失败，请稍后重试"},{status:500})}}r()}catch(e){r(e)}})}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[276,972,857,114,163],()=>s(38937));module.exports=r})();